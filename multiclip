#!/usr/bin/env python3
# SPDX-License-Identifier: BSD-3-Clause
# Copyright (c) 2025 Kubota Kaito


import sys
import os

SLOT_DIR = os.path.expanduser("~/.multiclip")


def ensure_dir():
    os.makedirs(SLOT_DIR, exist_ok=True)


def is_valid_slot(s: str) -> bool:
    return s.isdigit() and 0 <= int(s) <= 9


def save(slot: str) -> int:
    """標準入力の内容を指定スロットに保存する"""
    data = sys.stdin.read()
    path = os.path.join(SLOT_DIR, slot)
    with open(path, "w", encoding="utf-8") as f:
        f.write(data)
    return 0


def load(slot: str) -> int:
    """指定スロットの内容を標準出力に出す"""
    path = os.path.join(SLOT_DIR, slot)
    if not os.path.exists(path):
        print(f"multiclip: slot {slot} is empty", file=sys.stderr)
        return 1
    with open(path, encoding="utf-8") as f:
        sys.stdout.write(f.read())
    return 0


def list_slots() -> int:
    """スロット0〜9の状態を一覧表示"""
    ensure_dir()
    for i in range(10):
        slot = str(i)
        path = os.path.join(SLOT_DIR, slot)
        if not os.path.exists(path):
            status = "empty"
        else:
            size = os.path.getsize(path)
            status = f"{size} bytes"
        print(f"{slot}: {status}")
    return 0


def main() -> None:
    ensure_dir()
    args = sys.argv[1:]

    if not args:
        print(
            "Usage:\n"
            "  echo TEXT | multiclip SLOT\n"
            "  multiclip --load SLOT\n"
            "  multiclip --list",
            file=sys.stderr,
        )
        sys.exit(1)

    # 一覧表示
    if args[0] == "--list":
        sys.exit(list_slots())

    # 読み出し
    if args[0] == "--load":
        if len(args) < 2 or not is_valid_slot(args[1]):
            print("multiclip: invalid slot", file=sys.stderr)
            sys.exit(1)
        sys.exit(load(args[1]))

    # ここまで来たら保存モード
    slot = args[0]
    if not is_valid_slot(slot):
        print("multiclip: invalid slot", file=sys.stderr)
        sys.exit(1)

    sys.exit(save(slot))


if __name__ == "__main__":
    main()
